image: docker:27.3.1
services:
  - name: docker:27.3.1-dind
    alias: docker

stages:
  - build
  - test
  - deploy

before_script:
  - docker version
  - docker compose version

build-job:
  stage: build
  tags: [build]
  script:
    - docker compose build

test-service2-job:
  stage: test
  tags: [test]
  script:
    - docker image ls
    - docker run --name s2-test --rm -p 8200:8200 devops-project-esa-service2 &
    - sleep 5
    - curl telnet://localhost:8200 | grep "Service2"
    - docker stop s2-test

deploy-job:
  stage: deploy
  tags: [deploy]
  script:
    - docker compose up -d
